name: Build Apollo

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ===========================================
  # Windows Build
  # ===========================================
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-boost
            mingw-w64-ucrt-x86_64-openssl
            mingw-w64-ucrt-x86_64-opus
            mingw-w64-ucrt-x86_64-ffmpeg
            mingw-w64-ucrt-x86_64-curl
            mingw-w64-ucrt-x86_64-libnotify
            mingw-w64-ucrt-x86_64-miniupnpc
            mingw-w64-ucrt-x86_64-nlohmann-json
            mingw-w64-ucrt-x86_64-onevpl
            git

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DSUNSHINE_ENABLE_WAYLAND=OFF \
            -DSUNSHINE_ENABLE_X11=OFF \
            -DSUNSHINE_ENABLE_DRM=OFF \
            -DSUNSHINE_ENABLE_CUDA=ON \
            -DFETCHCONTENT_FULLY_DISCONNECTED=OFF

      - name: Build
        shell: msys2 {0}
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Package
        shell: msys2 {0}
        run: |
          mkdir -p package/apollo
          cp build/sunshine*.exe package/apollo/apollo.exe 2>/dev/null || cp build/apollo*.exe package/apollo/ 2>/dev/null || true
          cp -r build/assets/web package/apollo/ 2>/dev/null || true
          
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apollo-windows-x64
          path: package/
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================
  # Linux AppImage Build (Ubuntu 24.04 for newer libs)
  # ===========================================
  build-linux-appimage:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libssl-dev \
            libboost-all-dev \
            libpulse-dev \
            libopus-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libdrm-dev \
            libwayland-dev \
            libx11-dev \
            libxrandr-dev \
            libxfixes-dev \
            libxcb1-dev \
            libxcb-shm0-dev \
            libxcb-xfixes0-dev \
            libva-dev \
            libvdpau-dev \
            libcap-dev \
            libcurl4-openssl-dev \
            libnotify-dev \
            libayatana-appindicator3-dev \
            libevdev-dev \
            libudev-dev \
            libsystemd-dev \
            libminiupnpc-dev \
            libfuse2 \
            libicu-dev \
            libnuma-dev \
            wget \
            nodejs \
            npm

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DSUNSHINE_ENABLE_WAYLAND=ON \
            -DSUNSHINE_ENABLE_X11=ON \
            -DSUNSHINE_ENABLE_DRM=ON \
            -DSUNSHINE_ENABLE_CUDA=OFF \
            -DFETCHCONTENT_FULLY_DISCONNECTED=OFF

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Install to AppDir
        run: |
          DESTDIR=${{github.workspace}}/AppDir cmake --install build
          
      - name: Create AppImage
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          # Create desktop file if not exists
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/apollo.desktop << 'EOF'
          [Desktop Entry]
          Name=Apollo
          Comment=Self-hosted game stream host
          Exec=apollo
          Icon=apollo
          Type=Application
          Categories=Network;RemoteAccess;
          EOF
          
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --output appimage \
            --desktop-file AppDir/usr/share/applications/apollo.desktop \
            || echo "AppImage creation had issues, continuing..."
            
          mv Apollo*.AppImage apollo-linux-x86_64.AppImage 2>/dev/null || true

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: apollo-linux-appimage
          path: "*.AppImage"
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================
  # Arch Linux Package (PKGBUILD)
  # ===========================================
  build-arch-pkg:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
      - name: Setup Arch Linux
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            git \
            cmake \
            ninja \
            boost \
            openssl \
            opus \
            ffmpeg \
            libdrm \
            wayland \
            libx11 \
            libxrandr \
            libxfixes \
            libxcb \
            libva \
            libvdpau \
            libcap \
            curl \
            libnotify \
            libayatana-appindicator \
            libevdev \
            systemd \
            miniupnpc \
            libpulse \
            npm \
            nodejs \
            icu \
            numactl
          
          # Create build user (makepkg can't run as root)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          
      - name: Fix permissions and git
        run: |
          chown -R builder:builder .
          git config --global --add safe.directory /__w/Apollo-Linux/Apollo-Linux

      - name: Build with CMake
        run: |
          su builder -c '
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/usr \
              -DSUNSHINE_ENABLE_WAYLAND=ON \
              -DSUNSHINE_ENABLE_X11=ON \
              -DSUNSHINE_ENABLE_DRM=ON \
              -DSUNSHINE_ENABLE_CUDA=OFF
            cmake --build build -j$(nproc)
          '

      - name: Create Package
        run: |
          mkdir -p pkg/usr/bin pkg/usr/share/apollo
          cp build/sunshine* pkg/usr/bin/apollo 2>/dev/null || true
          chmod 755 pkg/usr/bin/apollo 2>/dev/null || true
          cp -r build/assets/* pkg/usr/share/apollo/ 2>/dev/null || true
          
          # Create simple tarball
          cd pkg && tar -czvf ../apollo-arch-linux-x86_64.tar.gz .

      - name: Upload Arch Package
        uses: actions/upload-artifact@v4
        with:
          name: apollo-arch-pkg
          path: "*.tar.gz"
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================
  # Debian/Ubuntu Package (.deb)
  # ===========================================
  build-deb:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libssl-dev \
            libboost-all-dev \
            libpulse-dev \
            libopus-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libdrm-dev \
            libwayland-dev \
            libx11-dev \
            libxrandr-dev \
            libxfixes-dev \
            libxcb1-dev \
            libxcb-shm0-dev \
            libxcb-xfixes0-dev \
            libva-dev \
            libvdpau-dev \
            libcap-dev \
            libcurl4-openssl-dev \
            libnotify-dev \
            libayatana-appindicator3-dev \
            libevdev-dev \
            libudev-dev \
            libsystemd-dev \
            libminiupnpc-dev \
            libicu-dev \
            libnuma-dev \
            dpkg-dev \
            debhelper \
            nodejs \
            npm

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DSUNSHINE_ENABLE_WAYLAND=ON \
            -DSUNSHINE_ENABLE_X11=ON \
            -DSUNSHINE_ENABLE_DRM=ON \
            -DSUNSHINE_ENABLE_CUDA=OFF

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Create DEB Package
        run: |
          VERSION="0.1.0"
          PKGDIR="apollo_${VERSION}_amd64"
          
          mkdir -p ${PKGDIR}/DEBIAN
          mkdir -p ${PKGDIR}/usr/bin
          mkdir -p ${PKGDIR}/usr/share/apollo
          mkdir -p ${PKGDIR}/usr/share/applications
          mkdir -p ${PKGDIR}/usr/share/icons/hicolor/scalable/apps
          mkdir -p ${PKGDIR}/usr/share/icons/hicolor/scalable/status
          mkdir -p ${PKGDIR}/usr/lib/systemd/user
          
          # Copy files
          cp build/sunshine* ${PKGDIR}/usr/bin/apollo 2>/dev/null || true
          chmod 755 ${PKGDIR}/usr/bin/apollo 2>/dev/null || true
          
          cp -r build/assets/web ${PKGDIR}/usr/share/apollo/ 2>/dev/null || true
          cp build/assets/*.png build/assets/*.json ${PKGDIR}/usr/share/apollo/ 2>/dev/null || true
          
          # Copy icons
          cp src_assets/linux/misc/icons/*.svg ${PKGDIR}/usr/share/icons/hicolor/scalable/apps/ 2>/dev/null || true
          
          # Create control file
          cat > ${PKGDIR}/DEBIAN/control << EOF
          Package: apollo
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libssl3, libboost-all-dev, libpulse0, libopus0, libdrm2, libwayland-client0, libx11-6, libva2, libcurl4, libnotify4, libayatana-appindicator3-1, libevdev2, libcap2
          Recommends: evdi-dkms
          Maintainer: Apollo Linux Fork
          Description: Self-hosted game stream host with Linux virtual display support
           Apollo is a game streaming server based on Sunshine with added
           support for Linux virtual displays using EVDI.
          EOF
          
          # Create postinst script
          cat > ${PKGDIR}/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          setcap cap_sys_admin+p /usr/bin/apollo || true
          if command -v modprobe &> /dev/null; then
            modprobe evdi 2>/dev/null || true
          fi
          gtk-update-icon-cache -f /usr/share/icons/hicolor/ 2>/dev/null || true
          EOF
          chmod 755 ${PKGDIR}/DEBIAN/postinst
          
          # Create systemd service
          cat > ${PKGDIR}/usr/lib/systemd/user/apollo.service << 'EOF'
          [Unit]
          Description=Apollo Game Streaming Server
          StartLimitIntervalSec=500
          StartLimitBurst=5

          [Service]
          ExecStartPre=/bin/sleep 5
          ExecStart=/usr/bin/apollo
          Restart=on-failure
          RestartSec=5s

          [Install]
          WantedBy=xdg-desktop-autostart.target
          EOF
          
          # Create desktop file
          cat > ${PKGDIR}/usr/share/applications/apollo.desktop << 'EOF'
          [Desktop Entry]
          Name=Apollo
          Comment=Self-hosted game stream host
          Exec=/usr/bin/env systemctl start --user apollo
          Icon=apollo
          Type=Application
          Categories=Network;RemoteAccess;
          EOF
          
          # Build package
          dpkg-deb --build ${PKGDIR}
          mv ${PKGDIR}.deb apollo_${VERSION}_amd64.deb

      - name: Upload DEB Package
        uses: actions/upload-artifact@v4
        with:
          name: apollo-deb
          path: "*.deb"
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================
  # Fedora RPM Build
  # ===========================================
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:40
    
    steps:
      - name: Install Dependencies
        run: |
          dnf install -y \
            git \
            cmake \
            ninja-build \
            gcc-c++ \
            boost-devel \
            openssl-devel \
            opus-devel \
            ffmpeg-free-devel \
            libdrm-devel \
            wayland-devel \
            libX11-devel \
            libXrandr-devel \
            libXfixes-devel \
            libxcb-devel \
            libva-devel \
            libvdpau-devel \
            libcap-devel \
            libcurl-devel \
            libnotify-devel \
            libayatana-appindicator-gtk3-devel \
            libevdev-devel \
            systemd-devel \
            miniupnpc-devel \
            pulseaudio-libs-devel \
            libicu-devel \
            numactl-devel \
            rpm-build \
            nodejs \
            npm

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Fix git safe directory
        run: git config --global --add safe.directory /__w/Apollo-Linux/Apollo-Linux

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DSUNSHINE_ENABLE_WAYLAND=ON \
            -DSUNSHINE_ENABLE_X11=ON \
            -DSUNSHINE_ENABLE_DRM=ON \
            -DSUNSHINE_ENABLE_CUDA=OFF

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Create RPM Package
        run: |
          VERSION="0.1.0"
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # Create tarball for RPM
          mkdir -p apollo-${VERSION}/usr/bin
          mkdir -p apollo-${VERSION}/usr/share/apollo
          cp build/sunshine* apollo-${VERSION}/usr/bin/apollo 2>/dev/null || true
          chmod 755 apollo-${VERSION}/usr/bin/apollo 2>/dev/null || true
          cp -r build/assets/* apollo-${VERSION}/usr/share/apollo/ 2>/dev/null || true
          tar -czvf ~/rpmbuild/SOURCES/apollo-${VERSION}.tar.gz apollo-${VERSION}
          
          cat > ~/rpmbuild/SPECS/apollo.spec << 'EOF'
          Name:           apollo
          Version:        0.1.0
          Release:        1%{?dist}
          Summary:        Self-hosted game stream host with Linux virtual display support
          License:        GPLv3
          URL:            https://github.com/MrOz59/Apollo-Linux
          Source0:        apollo-%{version}.tar.gz

          %description
          Apollo is a game streaming server based on Sunshine with added
          support for Linux virtual displays using EVDI.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/usr/share/apollo
          cp -r usr/bin/* %{buildroot}/usr/bin/ || true
          cp -r usr/share/apollo/* %{buildroot}/usr/share/apollo/ || true

          %files
          %attr(755,root,root) /usr/bin/apollo
          /usr/share/apollo

          %post
          setcap cap_sys_admin+p /usr/bin/apollo || true
          EOF
          
          rpmbuild -bb ~/rpmbuild/SPECS/apollo.spec || echo "RPM build had issues"
          cp ~/rpmbuild/RPMS/*/*.rpm . 2>/dev/null || true

      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: apollo-rpm
          path: "*.rpm"
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================
  # Create Release (on tag)
  # ===========================================
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows, build-linux-appimage, build-deb, build-arch-pkg, build-rpm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: find artifacts/ -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
